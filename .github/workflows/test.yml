name: Test KVM Installation Script

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: |
          echo "=== Checking bash syntax ==="
          bash -n kvm-install.sh
          echo "✅ Syntax check passed"

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          echo "=== Running ShellCheck ==="
          shellcheck kvm-install.sh || true
          echo "✅ ShellCheck completed"

  structure-validation:
    name: Script Structure Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate script structure
        run: |
          echo "=== Validating script structure ==="

          # Check for required functions
          FUNCTIONS=("check_root" "check_ubuntu_version" "check_virtualization" "install_kvm" "configure_libvirt" "verify_kvm" "install_cockpit")

          for func in "${FUNCTIONS[@]}"; do
            if grep -q "^$func()" kvm-install.sh || grep -q "^function $func" kvm-install.sh; then
              echo "✅ Function found: $func"
            else
              echo "❌ Function not found: $func"
              exit 1
            fi
          done

          # Check for error handling
          if grep -q "set -e" kvm-install.sh; then
            echo "✅ Error handling (set -e) found"
          else
            echo "⚠️  Warning: No 'set -e' found"
          fi

          # Check for root check
          if grep -q "EUID -ne 0" kvm-install.sh; then
            echo "✅ Root check implemented"
          else
            echo "❌ Root check not found"
            exit 1
          fi

          echo "✅ Structure validation passed"

  dry-run-test:
    name: Dry-Run Test on Ubuntu 24.04
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create dry-run version
        run: |
          echo "=== Creating dry-run version ==="

          # Replace actual commands with echo statements
          sed 's/apt-get update/echo "[DRY-RUN] apt-get update"/g; 
               s/apt-get install/echo "[DRY-RUN] apt-get install"/g; 
               s/apt-get upgrade/echo "[DRY-RUN] apt-get upgrade"/g;
               s/systemctl enable/echo "[DRY-RUN] systemctl enable"/g;
               s/systemctl start/echo "[DRY-RUN] systemctl start"/g;
               s/systemctl is-active/echo "[DRY-RUN] systemctl is-active"/g;
               s/usermod -aG/echo "[DRY-RUN] usermod -aG"/g;
               s/ufw allow/echo "[DRY-RUN] ufw allow"/g;
               s/virsh /echo "[DRY-RUN] virsh "/g' kvm-install.sh > kvm-install-dryrun.sh

          chmod +x kvm-install-dryrun.sh

      - name: Run dry-run test
        run: |
          echo "=== Running dry-run test ==="
          echo "y" | sudo bash kvm-install-dryrun.sh || {
            echo "⚠️  Dry-run completed with warnings (expected)"
            exit 0
          }

  docker-test:
    name: Docker Container Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          echo "=== Building Docker test image ==="
          docker build -f Dockerfile.test -t kvm-install-test:latest .

      - name: Run syntax check in container
        run: |
          echo "=== Running syntax check in container ==="
          docker run --rm kvm-install-test:latest bash -n /opt/kvm-install/kvm-install.sh
          echo "✅ Container syntax check passed"

      - name: Run structure test in container
        run: |
          echo "=== Running structure test in container ==="
          docker run --rm kvm-install-test:latest bash -c "
            grep -q 'check_root' /opt/kvm-install/kvm-install.sh && echo '✅ check_root found' || exit 1
            grep -q 'install_kvm' /opt/kvm-install/kvm-install.sh && echo '✅ install_kvm found' || exit 1
            grep -q 'install_cockpit' /opt/kvm-install/kvm-install.sh && echo '✅ install_cockpit found' || exit 1
            echo '✅ Structure test passed'
          "

      - name: Run OS compatibility check
        run: |
          echo "=== Running OS compatibility check ==="
          docker run --rm kvm-install-test:latest bash -c "
            cat /etc/os-release | grep -i ubuntu && echo '✅ Ubuntu detected' || exit 1
            which apt-get && echo '✅ apt-get available' || exit 1
            which systemctl && echo '✅ systemctl available' || exit 1
          "

  integration-test:
    name: Integration Test (Privileged)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check system info
        run: |
          echo "=== System Information ==="
          uname -a
          cat /etc/os-release
          echo ""
          echo "=== CPU Info ==="
          egrep -c '(vmx|svm)' /proc/cpuinfo || echo "No VT-x/AMD-V detected"
          echo ""

      - name: Install dependencies only
        run: |
          echo "=== Installing test dependencies ==="
          sudo apt-get update
          sudo apt-get install -y cpu-checker

          echo ""
          echo "=== Checking KVM support ==="
          egrep -c '(vmx|svm)' /proc/cpuinfo || echo "⚠️  No hardware virtualization detected (expected in GitHub Actions)"

      - name: Verify script requirements
        run: |
          echo "=== Verifying script can detect OS ==="
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            echo "OS: $PRETTY_NAME"
            if [[ "$ID" == "ubuntu" ]]; then
              echo "✅ Ubuntu detected"
            fi
          fi

          echo ""
          echo "=== Verifying required commands ==="
          which apt-get && echo "✅ apt-get available"
          which systemctl && echo "✅ systemctl available"
          which grep && echo "✅ grep available"

          echo "✅ All requirements met"

  test-script-runner:
    name: Test with test-kvm-install.sh
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run test script
        run: |
          echo "=== Running test-kvm-install.sh ==="
          chmod +x test-kvm-install.sh
          ./test-kvm-install.sh

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint '*.md' --ignore node_modules || true
          echo "✅ Markdown lint completed"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        syntax-check,
        structure-validation,
        dry-run-test,
        docker-test,
        integration-test,
        test-script-runner,
      ]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# KVM Installation Script Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Status" >> $GITHUB_STEP_SUMMARY
          echo "- Syntax Check: ${{ needs.syntax-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Structure Validation: ${{ needs.structure-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry-Run Test: ${{ needs.dry-run-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Test: ${{ needs.docker-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Test: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Script Runner: ${{ needs.test-script-runner.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Notes" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions runners do not have nested virtualization" >> $GITHUB_STEP_SUMMARY
          echo "- Full KVM functionality cannot be tested in CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "- Tests focus on syntax, structure, and logic validation" >> $GITHUB_STEP_SUMMARY
